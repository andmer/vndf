source project.conf

SOURCE_FILES=source/server/main.c
BINARY=$OUTPUT_DIR/vndf-server

UPSTART_JOB=source/upstart/vndf-server.conf
DEPLOY_DIR=/opt/vndf
BINARY_NAME=$(basename $BINARY)

function deployServer() {
	echo "Deploying server..."

	./scripts/zwobot/zwobot-compile $SOURCE_FILES "" "" $BINARY

	./scripts/nomad/nomad-ssh root "mkdir -p $DEPLOY_DIR"
	./scripts/nomad/nomad-scp root $BINARY $DEPLOY_DIR/$BINARY_NAME-new
	./scripts/nomad/nomad-scp root source/upstart/vndf-server.conf /etc/init
	./scripts/nomad/nomad-ssh root \
		"cd $DEPLOY_DIR; rm $BINARY_NAME; mv $BINARY_NAME-new $BINARY_NAME;
		killall $BINARY_NAME; start vndf-server"

	echo "Server deployed."
}

deployServer

while inotifywait -qq -e modify $SOURCE_FILES $UPSTART_JOB; do
	echo "Change detected."
	deployServer
done
