source project.conf

SOURCE_FILES=source/server/main.c
BINARY=$OUTPUT_DIR/vndf-server

UPSTART_JOB=source/upstart/vndf-server.conf
DEPLOY_DIR=/opt/vndf
BINARY_NAME=$(basename $BINARY)

function deployServer() {
	echo "Deploying server..."

	./scripts/zwobot/zwobot-compile $SOURCE_FILES "" "" $BINARY

	./scripts/nomad/nomad-scp root "$BINARY $UPSTART_JOB" "~/"
	./scripts/nomad/nomad-ssh root \
		"mkdir -p $DEPLOY_DIR; mv -f $BINARY_NAME $DEPLOY_DIR;
		mv $(basename $UPSTART_JOB) /etc/init;
		killall $BINARY_NAME; start $BINARY_NAME"

	echo "Server deployed."
}

deployServer

while inotifywait -qq -e modify $SOURCE_FILES $UPSTART_JOB; do
	echo "Change detected."
	deployServer
done
