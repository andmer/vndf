export BINARY_NAME=vndf-server
export SOURCE_FILES=source/server/main.c
export UPSTART_JOB=source/upstart/vndf-server.conf

function deployServer() {
	echo "Deploying server..."

	source ./scripts/helper/compile

	./scripts/nomad/nomad-ssh root "mkdir -p /opt/vndf"
	./scripts/nomad/nomad-scp root $BINARY /opt/vndf
	./scripts/nomad/nomad-scp root source/upstart/vndf-server.conf /etc/init
	./scripts/nomad/nomad-ssh root "killall $BINARY_NAME; start vndf-server"

	echo "Server deployed."
}

deployServer

while inotifywait -qq -e modify $SOURCE_FILES $UPSTART_JOB; do
	echo "Change detected."
	deployServer
done
